<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Ricerca Prodotti - Sitarello</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/products.css?v=10}" />
    <link rel="stylesheet" th:href="@{/css/products-search.css?v=6}" />
    <link rel="stylesheet" th:href="@{/css/rating-stars.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
</head>
<body class="products-page">
    <!-- Animated Background -->
    <div class="animated-bg"></div>
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
    
    <div th:insert="~{fragments/navbar :: navbar}"></div>

    <main class="container">
        <h1>Ricerca Prodotti</h1>
        
        <!-- Sezione Filtri di Ricerca -->
        <div class="search-container">
            <div class="search-header">
                <h2 class="search-title">üîç Trova il tuo prodotto ideale</h2>
                <p class="search-subtitle">Utilizza i filtri per restringere la ricerca</p>
            </div>
            
            <form th:action="@{/products/search}" th:object="${searchDTO}" method="get" class="search-form">
                <!-- Filtri Base -->
                <div class="filters-section basic-filters">
                    <h3 class="section-title">üéØ Ricerca Base</h3>
                    <div class="search-row">
                        <div class="form-group">
                            <label for="searchTerm">üî§ Cerca per nome o descrizione:</label>
                            <input type="text" id="searchTerm" th:field="*{searchTerm}" 
                                   placeholder="Inserisci una parola chiave..." />
                        </div>
                        
                        <div class="form-group">
                            <label for="categoria">üìÇ Categoria:</label>
                            <select id="categoria" th:field="*{categoria}">
                                <option value="">Tutte le categorie</option>
                                <option th:each="cat : ${categories}" 
                                        th:value="${cat.name}" 
                                        th:text="${cat.name}"
                                        th:selected="${searchDTO.categoria == cat.name}">Categoria</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Filtri Avanzati -->
                <div class="filters-section advanced-filters">
                    <div class="section-header" onclick="toggleAdvancedFilters()">
                        <h3 class="section-title">‚öôÔ∏è Filtri Avanzati</h3>
                        <span class="toggle-icon" id="advancedToggle">‚ñº</span>
                    </div>
                    
                    <div class="advanced-content" id="advancedFiltersContent">
                        <div class="search-row">
                            <div class="form-group">
                                <label for="prezzoMin">üí∞ Prezzo minimo (‚Ç¨):</label>
                                <input type="number" id="prezzoMin" th:field="*{prezzoMin}" 
                                       min="0" step="0.01" placeholder="0.00" />
                            </div>
                            
                            <div class="form-group">
                                <label for="prezzoMax">üí∞ Prezzo massimo (‚Ç¨):</label>
                                <input type="number" id="prezzoMax" th:field="*{prezzoMax}" 
                                       min="0" step="0.01" placeholder="1000.00" />
                            </div>
                            
                            <div class="form-group">
                                <label for="ratingMin">‚≠ê Valutazione minima:</label>
                                <select id="ratingMin" th:field="*{ratingMin}">
                                    <option value="">Qualsiasi valutazione</option>
                                    <option value="1">‚≠ê e superiori</option>
                                    <option value="2">‚≠ê‚≠ê e superiori</option>
                                    <option value="3">‚≠ê‚≠ê‚≠ê e superiori</option>
                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê e superiori</option>
                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Solo il meglio</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="sortBy">üìä Ordina per:</label>
                                <select id="sortBy" th:field="*{sortBy}">
                                    <option value="id">üïí Pi√π recenti</option>
                                    <option value="name">üî§ Nome A-Z</option>
                                    <option value="price">üí∞ Prezzo crescente</option>
                                    <option value="price_desc">üí∞ Prezzo decrescente</option>
                                    <option value="category">üìÇ Categoria</option>
                                    <option value="rating">‚≠ê Valutazione pi√π alta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="search-actions">
                    <button type="submit" class="btn btn-primary">üîç Cerca Prodotti</button>
                    <a th:href="@{/products/reset}" class="btn btn-outline">üîÑ Reset Filtri</a>
                    <a th:href="@{/}" class="btn btn-secondary">üè† Torna alla Home</a>
                </div>
            </form>
        </div>
        
        <!-- Filtri Attivi -->
        <div th:if="${hasFilters}" class="active-filters">
            <h4>Filtri attivi:</h4>
            <span th:if="${searchDTO.hasSearchTerm()}" class="filter-tag">
                üîç "<span th:text="${searchDTO.searchTerm}"></span>"
            </span>
            <span th:if="${searchDTO.hasCategoria()}" class="filter-tag">
                üìÇ <span th:text="${searchDTO.categoria}"></span>
            </span>
            <span th:if="${searchDTO.hasPrezzoMin()}" class="filter-tag">
                üí∞ Min: ‚Ç¨<span th:text="${searchDTO.prezzoMin}"></span>
            </span>
            <span th:if="${searchDTO.hasPrezzoMax()}" class="filter-tag">
                üí∞ Max: ‚Ç¨<span th:text="${searchDTO.prezzoMax}"></span>
            </span>
            <span th:if="${searchDTO.hasRatingMin()}" class="filter-tag">
                ‚≠ê Min: <span th:text="${searchDTO.ratingMin}"></span> stelle
            </span>
        </div>
        
        <!-- Header Risultati -->
        <div class="results-header">
            <div class="results-count">
                <strong th:text="${totalProducts}">0</strong> prodotti trovati
                <span th:if="${searchDTO.hasRatingMin()}" class="rating-filter-info">
                    (filtrati con valutazione ‚â• <span th:text="${searchDTO.ratingMin}"></span> stelle)
                </span>
                <span th:if="${searchDTO.sortBy == 'rating'}" class="rating-sort-info">
                    (ordinati per valutazione pi√π alta)
                </span>
            </div>
        </div>
        
        <!-- Risultati -->
        <div th:if="${totalProducts > 0}" class="products-grid">
            <div th:each="product : ${products}" class="product-card">
                <div class="product-title" th:text="${product.name}">Nome Prodotto</div>
                
                <div class="product-meta">
                    <div>
                        <span class="label">Categoria:</span>
                        <span class="value" th:text="${product.category.name}">Categoria</span>
                    </div>
                    <div>
                        <span class="label">Venditore:</span>
                        <span class="value" th:text="${product.seller.username}">Venditore</span>
                    </div>
                    <div>
                        <span class="label">Valutazione:</span>
                        <div th:replace="~{fragments/rating-stars :: rating-stars(${product.getAverageRating()}, ${product.getRatingCount()})}"></div>
                    </div>
                </div>
                
                <div class="product-price">
                    ‚Ç¨<span th:text="${#numbers.formatDecimal(product.price, 1, 2)}">0.00</span>
                </div>
                
                <div class="product-description" th:text="${product.description}">
                    Descrizione del prodotto...
                </div>
                
                <div th:if="${product.images != null and not #lists.isEmpty(product.images)}" class="product-images">
                    <img th:each="image : ${product.images}" 
                         th:src="@{'/product/image/' + ${image.id}}" 
                         th:alt="${product.name}" />
                </div>
                
                <div class="product-actions">
                    <a th:href="@{'/product/details/' + ${product.id}}" class="btn btn-primary btn-sm">
                        üëÅÔ∏è Visualizza
                    </a>
                    
                    <!-- Pulsanti di modifica solo se l'utente √® autenticato e proprietario del prodotto -->
                    <div th:if="${isAuthenticated and product.seller.username == username}">
                        <a th:href="@{'/product/edit/' + ${product.id}}" class="btn btn-outline btn-sm">
                            ‚úèÔ∏è Modifica
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nessun Risultato -->
        <div th:if="${totalProducts == 0}" class="no-results">
            <h3>üîç Nessun prodotto trovato</h3>
            <p>Prova a modificare i filtri di ricerca o <a th:href="@{/products/reset}">rimuovi tutti i filtri</a>.</p>
        </div>
    </main>
    
    <!-- Include footer fragment -->
    <div th:insert="~{fragments/footer :: footer}"></div>    
    <script th:src="@{/js/products-search.js}"></script>
</body>
</html>


